name: Build ChaWrt Firmware (with Caching)

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 350  # å°äº 6 å°æ—¶ï¼ˆ360 åˆ†é’Ÿï¼‰ï¼Œé¢„ç•™ç¼“å†²

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          sudo apt update
          sudo apt install -y \
            build-essential clang flex bison g++ gawk gcc-multilib \
            gettext git libncurses-dev libssl-dev rsync unzip \
            zlib1g-dev file wget curl python3

      - name: Restore cache (dl and toolchain)
        uses: actions/cache@v4
        id: cache-openwrt
        with:
          path: |
            dl
            staging_dir
            build_dir
            .config
          key: openwrt-${{ hashFiles('x86.config') }}-${{ runner.os }}
          restore-keys: |
            openwrt-${{ hashFiles('x86.config') }}
            openwrt-

      - name: Apply config
        run: |
          if [ ! -f x86.config ]; then
            exit 1
          fi
          cp x86.config .config

      - name: Update and install feeds
        run: |
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: Build firmware with safe parallelism and keep-alive output
        run: |
          echo "Starting build at $(date)"
          # ä½¿ç”¨ nproc ä½†é™åˆ¶æœ€å¤§å€¼ï¼ˆé˜²æ­¢ OOMï¼‰
          JOBS=$(($(nproc) < 4 ? $(nproc) : 4))
          echo "Using $JOBS parallel jobs"

          # å¯åŠ¨ä¸€ä¸ªåå°è¿›ç¨‹ï¼Œæ¯ 300 ç§’è¾“å‡ºä¸€è¡Œï¼Œé˜²æ­¢é™é»˜è¶…æ—¶
          while true; do
            echo "ğŸ—ï¸  Build still running... $(date)"
            sleep 300
          done &
          KEEPALIVE_PID=$!

          # æ‰§è¡Œç¼–è¯‘ï¼ˆå¸¦è¯¦ç»†æ—¥å¿—ï¼‰
          make -j${JOBS} V=s 2>&1 | tee build.log

          # ç¼–è¯‘å®Œæˆåæ€æ­» keep-alive è¿›ç¨‹
          kill $KEEPALIVE_PID || true
          echo "Build finished at $(date)"

      - name: Find firmware directory
        id: find_fw
        run: |
          FW_DIR=$(find bin/targets -type d | grep -v "packages" | head -n1)
          if [ -z "$FW_DIR" ] || [ ! -d "$FW_DIR" ]; then
            echo "âŒ No firmware output found!"
            exit 1
          fi
          echo "Firmware dir: $FW_DIR"
          echo "fw_dir=$FW_DIR" >> $GITHUB_ENV
          ls -lh "$FW_DIR"

      - name: Upload firmware artifact
        uses: actions/upload-artifact@v4
        with:
          name: ChaWrt-Firmware-${{ github.run_id }}
          path: ${{ env.fw_dir }}
          retention-days: 7

      - name: Upload build log (for debugging)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-log-${{ github.run_id }}
          path: build.log
          retention-days: 7
