name: Build ChaWrt in Docker

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker
        uses: docker/setup-docker-action@v3

      - name: Restore cache
        uses: actions/cache@v4
        id: cache
        with:
          path: |
            dl
            staging_dir
            build_dir
          key: chawrt-docker-${{ hashFiles('x86.config') }}-${{ runner.os }}
          restore-keys: |
            chawrt-docker-${{ hashFiles('x86.config') }}
            chawrt-docker-

      - name: Build in Docker container
        run: |
          # æž„å»ºä¸´æ—¶ Dockerfileï¼ˆåŸºäºŽ Ubuntu 22.04ï¼‰
          cat > Dockerfile << 'EOF'
          FROM ubuntu:22.04
          ENV DEBIAN_FRONTEND=noninteractive
          RUN apt update && \
              apt install -y --no-install-recommends \
                build-essential clang flex bison g++ gawk gcc-multilib \
                gettext git libncurses-dev libssl-dev rsync unzip \
                zlib1g-dev file wget curl python3 && \
              rm -rf /var/lib/apt/lists/*
          WORKDIR /chawrt
          EOF

          # æž„å»ºé•œåƒ
          docker build -t chawrt-builder .

          # å¯åŠ¨åŽå° keep-alive
          while true; do echo "ðŸ³ Docker build running... $(date)"; sleep 300; done &
          KEEPALIVE_PID=$!

          # è¿è¡Œå®¹å™¨ï¼ŒæŒ‚è½½å½“å‰ç›®å½•å’Œç¼“å­˜ç›®å½•
          docker run --rm \
            -v "$(pwd)":/chawrt \
            -w /chawrt \
            --cpus="3" \
            --memory="6g" \
            chawrt-builder \
            bash -c "
              cp x86.config .config && \
              ./scripts/feeds update -a && \
              ./scripts/feeds install -a && \
              JOBS=\$(nproc) && [ \$JOBS -gt 4 ] && JOBS=4; \
              make -j\$JOBS V=s
            "

          kill $KEEPALIVE_PID || true

      - name: Find and upload firmware
        id: find_fw
        run: |
          FW_DIR=$(find bin/targets -type d 2>/dev/null | grep -v packages | head -n1)
          if [ -z "$FW_DIR" ]; then
            echo "âŒ No firmware found!"
            exit 1
          fi
          echo "fw_dir=$FW_DIR" >> $GITHUB_ENV
          ls -lh "$FW_DIR"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ChaWrt-Docker-Firmware
          path: ${{ env.fw_dir }}
          retention-days: 7
